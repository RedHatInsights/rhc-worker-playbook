%{?python_disable_dependency_generator}
%define _debugsource_template %{nil}
%define community_general_version 4.4.0
%define ansible_posix_version 1.3.0
%global debug_package %{nil}

Name:       rhc-worker-playbook
Version:    @PKGVER@
Release:    @RELEASE@%{?dist}
Summary:    Python worker for Red Hat connector that launches Ansible Runner
License:    GPLv2+
URL:        https://github.com/redhatinsights/rhc-worker-playbook
Source0:     %{name}-%{version}.tar.gz
Source1:    https://github.com/ansible-collections/community.general/archive/%{community_general_version}/ansible-collection-community-general-%{community_general_version}.tar.gz
Source2:    https://github.com/ansible-collections/ansible.posix/archive/%{ansible_posix_version}/ansible-collection-ansible-posix-%{ansible_posix_version}.tar.gz
# ansible-runner dependencies
Source3:    https://files.pythonhosted.org/packages/py3/a/ansible_runner/ansible_runner-2.1.1-py3-none-any.whl
Source4:    https://files.pythonhosted.org/packages/py3/p/python_daemon/python_daemon-3.1.2-py3-none-any.whl
Source5:    https://files.pythonhosted.org/packages/py2.py3/l/lockfile/lockfile-0.12.2-py2.py3-none-any.whl
# x86_64 grpcio/protobuf sources
Source6:    https://files.pythonhosted.org/packages/cp39/g/grpcio/grpcio-1.55.3-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
Source7:    https://files.pythonhosted.org/packages/cp39/g/grpcio_tools/grpcio_tools-1.48.2-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
Source8:    https://files.pythonhosted.org/packages/cp39/p/protobuf/protobuf-3.20.0-cp39-cp39-manylinux_2_5_x86_64.manylinux1_x86_64.whl
# aarch64 grpcio/protobuf sources
Source9:    https://files.pythonhosted.org/packages/cp39/g/grpcio/grpcio-1.55.3-cp39-cp39-manylinux_2_17_aarch64.whl
Source10:   https://files.pythonhosted.org/packages/cp39/g/grpcio_tools/grpcio_tools-1.48.2-cp39-cp39-manylinux_2_17_aarch64.whl
Source11:   https://files.pythonhosted.org/packages/cp39/p/protobuf/protobuf-3.20.0-cp39-cp39-manylinux2014_aarch64.whl
# other arch grpcio/protobuf sources
Source12:   %pypi_source grpcio 1.55.3
Source13:   %pypi_source grpcio-tools 1.48.2
Source14:   %pypi_source protobuf 3.20.0

Requires: python3.9
Requires: rhc
Requires: rhc-playbook-verifier
Requires: ansible-core
Requires: python3.9dist(setuptools)
Requires: python3.9dist(requests)
Requires: python3.9dist(toml)
Requires: python3.9dist(jsonschema)
# ansible-runner dependencies
Requires: python3.9dist(pexpect)
Requires: python3.9dist(pyyaml)
Requires: python3.9dist(six)
BuildRequires: make
BuildRequires: python3-devel
BuildRequires: python3.9dist(pip)
BuildRequires: python3.9dist(wheel)
BuildRequires: python3.9dist(setuptools)
BuildRequires: python3.9dist(pexpect)
BuildRequires: python3.9dist(pyyaml)
BuildRequires: python3.9dist(six)
%ifnarch x86_64 aarch64
BuildRequires: openssl-devel
BuildRequires: c-ares-devel
BuildRequires: zlib-devel
BuildRequires: python3.9dist(cython)
BuildRequires: gcc
BuildRequires: gcc-c++
%endif

ExcludeArch:   i686

%description
Python-based worker for Red Hat connect, used to launch Ansible playbooks via Ansible Runner.

%prep
%setup -q -a1 -a2 -n %{name}-%{version}

pushd community.general-%{community_general_version}
rm -vr .github .azure-pipelines
rm -rvf tests/ hacking/
find -type f ! -executable -name '*.py' -print -exec sed -i -e '1{\@^#!.*@d}' '{}' +
find -type f -name '.gitignore' -print -delete
popd

pushd ansible.posix-%{ansible_posix_version}
rm -vr tests/{integration,utils} .github changelogs/fragments/.keep {test-,}requirements.txt shippable.yml
rm -vr .azure-pipelines
rm -rvf tests/
find -type f ! -executable -name '*.py' -print -exec sed -i -e '1{\@^#!.*@d}' '{}' +
find -type f -name '.gitignore' -print -delete
popd

%build
%ifnarch x86_64 aarch64
%define _lto_cflags %{nil}
%set_build_flags
export GRPC_PYTHON_BUILD_WITH_CYTHON=True
export GRPC_PYTHON_BUILD_SYSTEM_OPENSSL=True
export GRPC_PYTHON_BUILD_SYSTEM_ZLIB=True
export GRPC_PYTHON_BUILD_SYSTEM_CARES=True
export GRPC_PYTHON_DISABLE_LIBC_COMPATIBILITY=True
%endif

# remove and remake the constants file for the correct LIBDIR
rm -f rhc_worker_playbook/constants.py
%{__make} LIBDIR=%{_libdir} rhc_worker_playbook/constants.py
mkdir wheels

# add ansible-runner and its dependencies
cp %{SOURCE3} %{SOURCE4} %{SOURCE5} wheels

%ifarch x86_64
# grpcio, protobuf x86_64
cp %{SOURCE6} %{SOURCE7} %{SOURCE8} wheels
%endif

%ifarch aarch64
# grpcio, protobuf aarch64
cp %{SOURCE9} %{SOURCE10} %{SOURCE11} wheels
%endif

%ifnarch x86_64 aarch64
# build grpcio, protobuf from source
%{python3} -m pip wheel --no-deps --wheel-dir=wheels . %{SOURCE12} %{SOURCE13} %{SOURCE14}
%endif

# build rhc-worker-playbook wheel
%{python3} -m pip wheel --no-deps --wheel-dir=wheels .
touch wheels

# Building the Ansible Collections
pushd community.general-%{community_general_version}
tar -cf %{_tmppath}/community-general-%{community_general_version}.tar.gz .
popd

pushd ansible.posix-%{ansible_posix_version}
tar -cf %{_tmppath}/ansible-posix-%{ansible_posix_version}.tar.gz .
popd

%install
%{make_install} PREFIX=%{_prefix} LIBDIR=%{_libdir} DEPENDENCY_WHEELS="wheels/ansible* wheels/grpcio* wheels/protobuf* wheels/python_daemon* wheels/lockfile*" PIP_INSTALL_EXTRA_ARGS="--no-deps"
# confirm Python dependencies are OK
PYTHONPATH=%{buildroot}%{_libdir}/rhc-worker-playbook %{python3} -m pip check

# Installing the Ansible Collections
mkdir -p %{buildroot}%{_datadir}/rhc-worker-playbook/ansible/collections/ansible_collections/community/general
mkdir -p %{buildroot}%{_datadir}/rhc-worker-playbook/ansible/collections/ansible_collections/ansible/posix

pushd %{buildroot}%{_datadir}/rhc-worker-playbook/ansible/collections/ansible_collections/community/general
tar -xf %{_tmppath}/community-general-%{community_general_version}.tar.gz
popd

pushd %{buildroot}%{_datadir}/rhc-worker-playbook/ansible/collections/ansible_collections/ansible/posix
tar -xf %{_tmppath}/ansible-posix-%{ansible_posix_version}.tar.gz
popd

# Creating the logs directory for ansible-runner
mkdir -p %{buildroot}%{_localstatedir}/log/rhc-worker-playbook/ansible/

%files
%{_libexecdir}/rhc/rhc-worker-playbook.worker
%{python3_sitelib}/rhc_worker_playbook/
%{python3_sitelib}/rhc_worker_playbook*.dist-info/
%{_libdir}/rhc-worker-playbook/
%{_datadir}/rhc-worker-playbook/ansible/collections/ansible_collections/
%{_localstatedir}/log/rhc-worker-playbook/ansible/
%config(noreplace) %{_sysconfdir}/rhc/workers/rhc-worker-playbook.toml

%doc

%changelog
